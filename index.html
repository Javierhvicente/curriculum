<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="css/index.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script language="javascript" type="text/javascript" src="js/validar.js"></script>
    <script  language="javascript" type="text/javascript">
        function recuperarDatos() {
            var nombre = document.getElementById("nombre").value;
            var email = document.getElementById("Email").value;
            var telefono = document.getElementById("Tlfno").value;
            var fechaCita = document.getElementById("fechaCita").value;
            var cp = document.getElementById("Cp").value;
            var gafas = document.getElementById("Gafas").checked;
            var lentillas = document.getElementById("Lentillas").checked;
            var dolencias = document.getElementById("Dolencias").value;
            var aceptarTerminos = document.getElementById("check1").checked;

            var datos = `
                Nombre: ${nombre}<br>
                Email: ${email}<br>
                Teléfono: ${telefono}<br>
                Fecha de Cita: ${fechaCita}<br>
                Código Postal: ${cp}<br>
                Producto: ${gafas ? "Gafas" : "Lentillas"}<br>
                Dolencias: ${dolencias}<br>
                Términos aceptados: ${aceptarTerminos ? "Sí" : "No"}
            `;

            return datos;
        }

        function validarCPInside(elemento, length) {
            if (!validarInt(elemento.value, length)) { 
                elemento.style.backgroundColor = "lightyellow";
                elemento.style.borderColor = "red";
                mostrar(elemento);
            } else if(!validarCodigoPostal(elemento.value)){
                elemento.style.backgroundColor = "lightyellow";
                elemento.style.borderColor = "red";
                mostrar(elemento);
            }else {
                elemento.style.backgroundColor = "";
                elemento.style.borderColor = "";
                noMostrar(elemento);
            }
        }  
        
        document.addEventListener("DOMContentLoaded", function() {
            var myModal = document.getElementById('myModal');
            myModal.addEventListener('hidden.bs.modal', function () {
                document.querySelector('.modal-backdrop').remove();
                document.body.classList.remove('modal-open');
                document.body.style = '';
            });
        });


        function validarForm() {
            var mensaje = "";
            var valido = true;

            var nombre = document.getElementById("nombre").value;
            var email = document.getElementById("Email").value;
            var telefono = document.getElementById("Tlfno").value;
            var fechaCita = document.getElementById("fechaCita").value;
            var cp = document.getElementById("Cp").value;
            var gafas = document.getElementById("Gafas").checked;
            var lentillas = document.getElementById("Lentillas").checked;
            var aceptarTerminos = document.getElementById("check1").checked;

            if (nombre.length < 2 || nombre.length > 60) {
                mensaje += "El nombre debe tener entre 2 y 60 caracteres.<br>";
                valido = false;
            }

            if (!email.includes("@")) {
                mensaje += "El email no es válido.<br>";
                valido = false;
            }

            if (!telefono.match(/^[0-9]{9}$/)) {
                mensaje += "El teléfono debe tener 9 dígitos.<br>";
                valido = false;
            }

            if (fechaCita === "") {
                mensaje += "Debes elegir una fecha para la cita.<br>";
                valido = false;
            }

            if (cp < 1000 || cp > 52999) {
                mensaje += "El código postal debe estar entre 1000 y 52999.<br>";
                valido = false;
            }

            if (!gafas && !lentillas) {
                mensaje += "Debes seleccionar entre Gafas o Lentillas.<br>";
                valido = false;
            }

            if (!aceptarTerminos) {
                mensaje += "Debes aceptar los términos y condiciones.<br>";
                valido = false;
            }

            return { valido: valido, mensaje: mensaje };
        }
        
        function manejarEnvio() {
            var resultadoValidacion = validarForm();
            var modalBody = document.querySelector('.modal-body');

            if (resultadoValidacion.valido) {
                modalBody.innerHTML = `<div class="alert alert-success">${recuperarDatos()}</div>`;
            } else {
                modalBody.innerHTML = `<div class="alert alert-danger">${resultadoValidacion.mensaje}</div>`;
            }

            var myModal = new bootstrap.Modal(document.getElementById('myModal'));
            myModal.show();
        }
        
    </script>
</head>
<body>
    <div id="body" class="container pt-5">
        <div id="header" class="mt-4 p-5 big-primary text-black rounded align-center">
            <header>
                <h1 id="titulo">Optica Boops</h1>
                <br>
                <h3>Información</h3>
            </header>
        </div>  
        <div>
            <form id="formulario">
                <div>
                    <label class="form-label">Nombre</label><br/>
                    <input class="form-control is-invalid" id="nombre" name="nombre" placeholder="Nombre" onblur="validarStringInside(this,2,60)">
                    <div class="invalid-feedback" id="errorNombre">Es obligatorio rellenar este campo y debe tener entre 2 y 60 caracteres</div>
                </div>
                <br>
                <div>
                    <label class="form-label">Email</label><br>
                    <input class="form-control is-invalid" id="Email" name="Email" placeholder="Email" onblur="revisarEmail(this)">
                    <div class="invalid-feedback" id="errorEmail">Es obligatorio rellenar este campo y debe tener entre 2 y 80 caracteres</div>
                </div>
                <br>
                <div>
                    <label class="form-label">Tlfno</label><br/>
                    <input class="form-control is-invalid" id="Tlfno" name="Tlfno" placeholder="Tlfno" onblur="validateNumTelefono(this,errorTlfno)">
                    <div class="invalid-feedback" id="errorTlfno">Es obligatorio rellenar este campo</div>
                </div>
                <br>
                <div class="row mt-4">
                    <div class="col">
                        <label class="linea form-label">CP</label>
                        <input class="caja form-control is-invalid" id="Cp" type="text" name="Cp" placeholder="Cod Postal" onblur="validarCPInside(this,4,errorCP);ConseguirProvincia(this)">
                        <div class="invalid-feedback" id="errorCP">El código postal es obligatorio y debe ser un número entre 1000 y 52999</div>
                    </div>
                    <div class="col">
                        <label class="linea form-label">Provincia</label>
                        <input class="caja form-control"  id="Provincia" name="Provincia" type="text" readonly>
                    </div>
                </div>
                <br>
                <div class="form-check" id="Optica" onmouseover="entraFoco(this)" onmouseout="saleFoco(this)">
                    <input class="Optica form-check-input is-invalid" id="Gafas" type="radio" name="Optica" value="Gafas" onchange="validarRadio(this)">
                    <label class="Optica form-check-label">Gafas</label>
                </div>
                <div class="form-check" id="Optica" onmouseover="entraFoco(this)" onmouseout="saleFoco(this)">
                    <input class="Optica form-check-input is-invalid" id="Lentillas" type="radio" name="Optica" value="Lentillas" onchange="validarRadio(this)">
                    <label class="Optica form-check-label">Lentillas</label>
                </div>
                <div class="invalid-feedback">Elige una de las 2 opciones</div>
                <br>
                <div>
                    <label class="form-label">Dolencias</label>
                    <select id="Dolencias" class="form-select is-invalid" multiple>
                        <option>Miopía</option>
                        <option>Astigmatismo</option>
                        <option>Ojos cansados</option>
                        <option>Hipermetropía</option>
                        <option>Hinchazón</option>
                        <option>Sensibilidad alta</option>
                    </select>
                    <div class="invalid-feedback" id="errorDolencias">Debes seleccionar al menos una dolencia</div>
                </div>
                <br>
                <label class="form-label">Fecha deseada</label>
                <input class="form-control" id="fechaCita" type="date" name="fechaCita" placeholder="Fecha Cita" onfocus="entraFoco(this)" onblur="saleFoco(this)">
                <p class="obligatorio" id="errorFechCita">Es obligatorio rellenar este campo</p>
                <br>
                <div class="form-floating">
                    <textarea class="form-control" id="Comentarios" placeholder="Comenta aquí!"></textarea>
                    <label for="Comentarios">Comentarios</label>
                </div>
                <br>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="check1" name="option1"  >
                    <label class="form-check-label">AceptarTerminos</label>
                  </div>
                <br>
                <button id="reset" class="btn btn-danger" type="reset" name="reset" value="reset">Borrar</button>
                <button type="button" class="btn btn-success" onclick="manejarEnvio()" data-bs-toggle="modal" data-bs-target="#myModal">Enviar</button>
                <!-- Coloca el modal fuera del formulario -->
                <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Resultado de la Validación</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body"></div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>    
</body>
</html>